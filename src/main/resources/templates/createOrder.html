<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazer pedido</title>
    <link rel="stylesheet" th:href="@{/css/order.css}">
</head>

<body>
    <header th:replace="~{shared/header}"></header>

    <main class="container">
        <h1 class="page-title">Fa√ßa seu Pedido</h1>

        <div class="order-layout">
            <!-- Se√ß√£o de Sele√ß√£o da Mesa -->
            <div class="desk-selection-section">
                <div class="section-header">
                    <h2>üìã Selecionar Mesa</h2>
                    <p>Escolha a mesa onde ser√° servido o pedido</p>
                </div>
                <div class="desk-grid">
                    <div th:each="desk : ${desks}" class="desk-card" th:data-desk-id="${desk.id}">
                        <div class="desk-icon">üçΩÔ∏è</div>
                        <div class="desk-info">
                            <h3 th:text="'Mesa ' + ${desk.id}">Mesa 1</h3>
                            <p th:text="${desk.seats} + ' lugares'">4 lugares</p>
                        </div>
                        <div class="desk-status available"></div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o do Card√°pio -->
            <div class="menu-section">
                <div class="section-header">
                    <h2>üìñ Card√°pio</h2>
                    <p>Selecione os itens para adicionar ao pedido</p>
                </div>

                <!-- Filtros de Categoria -->
                <div class="category-filters">
                    <button class="filter-btn active" data-category="all">Todos</button>
                    <button class="filter-btn" data-category="entradas">Entradas</button>
                    <button class="filter-btn" data-category="principais">Pratos Principais</button>
                    <button class="filter-btn" data-category="bebidas">Bebidas</button>
                    <button class="filter-btn" data-category="sobremesas">Sobremesas</button>
                </div>

                <!-- Grid de Produtos -->
                <div class="products-grid">
                    <div th:each="product : ${products}" class="product-card" th:data-product-id="${product.id}">
                        <div class="product-info">
                            <h3 th:text="${product.name}">Nome do Produto</h3>
                            <p class="product-description" th:text="${product.description}">Descri√ß√£o do produto</p>
                            <div class="product-price"
                                th:text="'R$ ' + ${#numbers.formatDecimal(product.price, 1, 2, 'POINT')}">R$ 25,90</div>
                        </div>
                        <div class="product-actions">
                            <div class="quantity-controls">
                                <button class="quantity-btn minus-btn" onclick="decreaseQuantity(this)">-</button>
                                <span class="quantity-display">0</span>
                                <button class="quantity-btn plus-btn" onclick="increaseQuantity(this)">+</button>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToCart(this)">
                                <i class="fas fa-cart-plus"></i>
                                Adicionar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carrinho de Compras -->
            <div class="cart-section">
                <div class="cart-container">
                    <div class="cart-header">
                        <h2>üõí Seu Pedido</h2>
                        <div class="cart-info">
                            <span class="items-count">0 itens</span>
                            <button class="clear-cart-btn" onclick="clearCart()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="cart-items">
                        <div class="empty-cart-message">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Seu carrinho est√° vazio</p>
                            <span>Adicione itens do card√°pio</span>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span class="subtotal-amount">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Taxa de servi√ßo:</span>
                            <span class="service-fee">R$ 0,00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span class="total-amount">R$ 0,00</span>
                        </div>
                    </div>

                    <form th:action="@{/api/orders}" method="post" class="order-form">
                        <input type="hidden" id="selectedDesk" name="deskId" required>
                        <input type="hidden" id="selectedProducts" name="productIds">

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="clearCart()">
                                <i class="fas fa-times"></i>
                                Limpar
                            </button>
                            <button type="submit" class="btn-primary" disabled>
                                <i class="fas fa-check"></i>
                                Finalizar Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úÖ Pedido Confirmado!</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Seu pedido foi enviado para a cozinha com sucesso!</p>
                <div class="order-details">
                    <p><strong>Mesa:</strong> <span id="modalDeskNumber">-</span></p>
                    <p><strong>Total de itens:</strong> <span id="modalItemsCount">0</span></p>
                    <p><strong>Valor total:</strong> <span id="modalTotalAmount">R$ 0,00</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal()">
                    <i class="fas fa-home"></i>
                    Voltar ao Card√°pio
                </button>
            </div>
        </div>
    </div>

    <footer th:replace="~{shared/footer}"></footer>
</body>
<script>
    let cart = [];
    let selectedDesk = null;
    const serviceFeeRate = 0.1; // 10% de taxa de servi√ßo

    // Sele√ß√£o de mesa
    function selectDesk(deskElement) {
        // Remove sele√ß√£o anterior
        document.querySelectorAll('.desk-card').forEach(desk => {
            desk.classList.remove('selected');
        });

        // Adiciona sele√ß√£o atual
        deskElement.classList.add('selected');
        selectedDesk = deskElement.getAttribute('data-desk-id');
        document.getElementById('selectedDesk').value = selectedDesk;

        updateSubmitButton();
    }

    // Controles de quantidade
    function increaseQuantity(button) {
        const quantityDisplay = button.parentElement.querySelector('.quantity-display');
        let quantity = parseInt(quantityDisplay.textContent) || 0;
        quantityDisplay.textContent = quantity + 1;
    }

    function decreaseQuantity(button) {
        const quantityDisplay = button.parentElement.querySelector('.quantity-display');
        let quantity = parseInt(quantityDisplay.textContent) || 0;
        if (quantity > 0) {
            quantityDisplay.textContent = quantity - 1;
        }
    }

    // Adicionar ao carrinho - FUN√á√ÉO PRINCIPAL CORRIGIDA
    function addToCart(button) {
        console.log('Fun√ß√£o addToCart chamada'); // Debug

        const productCard = button.closest('.product-card');
        const productId = productCard.getAttribute('data-product-id');
        const productName = productCard.querySelector('h3').textContent;

        // Corrigir extra√ß√£o do pre√ßo
        const priceText = productCard.querySelector('.product-price').textContent;
        const productPrice = parseFloat(priceText.replace('R$ ', '').replace(',', '.'));

        const quantityElement = productCard.querySelector('.quantity-display');
        const quantity = parseInt(quantityElement.textContent) || 0;

        console.log('Produto:', productName, 'Pre√ßo:', productPrice, 'Quantidade:', quantity); // Debug

        if (quantity === 0) {
            showNotification('Selecione a quantidade desejada', 'warning');
            return;
        }

        if (!selectedDesk) {
            showNotification('Selecione uma mesa primeiro', 'warning');
            return;
        }

        // Adiciona ou atualiza item no carrinho
        const existingItemIndex = cart.findIndex(item => item.id === productId);
        if (existingItemIndex > -1) {
            cart[existingItemIndex].quantity += quantity;
        } else {
            cart.push({
                id: productId,
                name: productName,
                price: productPrice,
                quantity: quantity
            });
        }

        // Reseta quantidade do produto
        quantityElement.textContent = '0';

        updateCart();
        showNotification(`${quantity}x ${productName} adicionado ao pedido!`, 'success');
    }

    // Atualizar carrinho
    function updateCart() {
        const cartItems = document.querySelector('.cart-items');
        const emptyMessage = document.querySelector('.empty-cart-message');
        const itemsCount = document.querySelector('.items-count');
        const subtotalAmount = document.querySelector('.subtotal-amount');
        const serviceFee = document.querySelector('.service-fee');
        const totalAmount = document.querySelector('.total-amount');
        const selectedProductsInput = document.getElementById('selectedProducts');

        if (cart.length === 0) {
            emptyMessage.style.display = 'flex';
            cartItems.innerHTML = '';
        } else {
            emptyMessage.style.display = 'none';

            let subtotal = 0;
            let cartHTML = '';

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                cartHTML += `
                    <div class="cart-item">
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p class="item-price">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                        </div>
                        <div class="item-controls">
                            <div class="item-quantity">
                                <button class="quantity-btn" onclick="decreaseCartItem(${index})">-</button>
                                <span>${item.quantity}</span>
                                <button class="quantity-btn" onclick="increaseCartItem(${index})">+</button>
                            </div>
                            <div class="item-total">R$ ${itemTotal.toFixed(2).replace('.', ',')}</div>
                            <button class="remove-item-btn" onclick="removeFromCart(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            cartItems.innerHTML = cartHTML;
            itemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'itens'}`;

            const serviceFeeValue = subtotal * serviceFeeRate;
            const total = subtotal + serviceFeeValue;

            subtotalAmount.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            serviceFee.textContent = `R$ ${serviceFeeValue.toFixed(2).replace('.', ',')}`;
            totalAmount.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

            // Atualiza input hidden com produtos selecionados
            const productIds = cart.map(item => `${item.id}:${item.quantity}`).join(',');
            selectedProductsInput.value = productIds;
        }

        updateSubmitButton();
    }

    // Controles do carrinho
    function increaseCartItem(index) {
        cart[index].quantity++;
        updateCart();
    }

    function decreaseCartItem(index) {
        if (cart[index].quantity > 1) {
            cart[index].quantity--;
        } else {
            cart.splice(index, 1);
        }
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
        showNotification('Item removido do carrinho', 'info');
    }

    function clearCart() {
        if (cart.length === 0) return;

        if (confirm('Tem certeza que deseja limpar o carrinho?')) {
            cart = [];
            updateCart();
            showNotification('Carrinho limpo', 'info');
        }
    }

    function updateSubmitButton() {
        const submitButton = document.querySelector('.order-form button[type="submit"]');
        const isValid = selectedDesk && cart.length > 0;
        submitButton.disabled = !isValid;

        if (isValid) {
            submitButton.classList.remove('disabled');
        } else {
            submitButton.classList.add('disabled');
        }
    }

    function showNotification(message, type = 'info') {
        // Criar notifica√ß√£o customizada
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;

        document.body.appendChild(notification);

        // Remover ap√≥s 3 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }

    function showOrderConfirmation() {
        const modal = document.getElementById('confirmationModal');
        const deskNumber = document.querySelector('.desk-card.selected h3')?.textContent || '-';
        const itemsCount = cart.reduce((total, item) => total + item.quantity, 0);
        const totalAmount = document.querySelector('.total-amount').textContent;

        document.getElementById('modalDeskNumber').textContent = deskNumber;
        document.getElementById('modalItemsCount').textContent = itemsCount;
        document.getElementById('modalTotalAmount').textContent = totalAmount;

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('confirmationModal').style.display = 'none';
        // Limpa o carrinho ap√≥s confirma√ß√£o
        cart = [];
        selectedDesk = null;
        updateCart();
        document.querySelectorAll('.desk-card').forEach(desk => {
            desk.classList.remove('selected');
        });
    }

    // Inicializa√ß√£o quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM carregado - inicializando funcionalidades'); // Debug

        // Filtros de categoria
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const category = this.getAttribute('data-category');
                document.querySelectorAll('.product-card').forEach(card => {
                    if (category === 'all' || card.getAttribute('data-category') === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Sele√ß√£o de mesa
        document.querySelectorAll('.desk-card').forEach(desk => {
            desk.addEventListener('click', function () {
                selectDesk(this);
            });
        });

        // Prevenir envio do formul√°rio para demonstra√ß√£o
        document.querySelector('.order-form').addEventListener('submit', function (e) {
            e.preventDefault();
            if (selectedDesk && cart.length > 0) {
                showOrderConfirmation();
            }
        });

        // Inicializar carrinho
        updateCart();

        console.log('Funcionalidades inicializadas com sucesso'); // Debug
    });

    // Adicionar CSS para notifica√ß√µes
    const style = document.createElement('style');
    style.textContent = `
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success { background: var(--success); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--info); }
        
        .notification button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary:disabled:hover {
            transform: none;
            box-shadow: none;
        }
    `;
    document.head.appendChild(style);
</script>

</html>